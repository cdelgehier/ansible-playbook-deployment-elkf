---

- hosts: elkservers
  become: true
  environment:
    ES_HEAP_SIZE: {{ es_heap_size }}
    LS_HEAP_SIZE: {{ ls_heap_size }}
    ES_CLUSTER_NAME: {{ es_cluster_name }}
  vars:
      elk_install_path: {{ docker_repo_path }}
      elk_repo_version: {{ docker_repo_path }}
  roles:
    - role: ansible-role-java

    - role: ansible-role-docker
      docker_install_compose: true
      docker_compose_version: "1.18.0"
      docker_apt_repository: "deb [arch=amd64] https://download.docker.com/linux/ubuntu xenial stable"
      docker_compose_path: "/usr/bin/docker-compose"
  tasks:
    - name: Increase the virtual memory
      shell: sysctl -w vm.max_map_count=262144

    - name: Creates directory
      file:
        path: "{{ elk_install_path }}"
        state: directory
    - name: Download elk
      unarchive:
        src: "https://github.com/papebadiane/docker-elkf/archive/{{ elk_repo_version}}.tar.gz"
        dest: "{{ elk_install_path }}"
        remote_src: true

    - name: "change the working directory {{ elk_install_path }}/docker-elkf-{{ elk_repo_version }} and run the container ELK"
      shell: docker-compose up -d --build elk
      args:
        chdir: "{{ elk_install_path }}/docker-elkf-{{ elk_repo_version }}"

    - name: Load kibana dashboard and visualization
      include_role:
        name: ansible-role-kibana-import-dashboard-and-visualization
      vars:
        kibana_server_group: elkservers
        kibana_interface: lo
        kibana_dashboard_path: "{{ elk_install_path }}/docker-elkf-{{ elk_repo_version }}/elk/kibana/dashboard/dashboard.json"
        kibana_visualization_path: "{{ elk_install_path }}/docker-elkf-{{ elk_repo_version }}/elk/kibana/dashboard/visualization.json"
        kibana_server_ip: "{{ hostvars[groups[kibana_server_group][0]]['ansible_'+ kibana_interface]['ipv4']['address'] }}"

...
